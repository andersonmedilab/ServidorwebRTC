<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tela de confirmação</title>
    <link rel="stylesheet" type="text/css" href="./salaEspera.css"><!--mudar-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.js"></script>
</head>
<body>
    <div class="container">
        <div class="box">
            <p id="texto">Confirmando sua consulta, aguarde por favor.</p><!--STATUS: OK-->
            <p id="posicao">Sua posição é: </p>
            <div id = "Status"><!--corfimado--></div>
            <button id="btn-sair" onclick="sairConsulta()">Sair da fila</button>  
            <!--Status de confirmação, idequip, idpaciente, data e hora
                botao de sair não querendo mais atendimento-->
    </div><!--box-->
</div><!--container-->
</body>
<script>
    function sairConsulta(){
        window.location.href="http://localhost:8080/mediagenda_web/#/dashboard"
    }
    $( document ).ready(function() {
    var link = "";
    var status
    var posicao = document.getElementById("posicao");
    var token = localStorage.getItem("mediAgendaToken")
    console.log(token)
    let json = {
        status,
        link
    };
    let stop = setInterval(function(){
        const Url = 'http://localhost:8080/mediagenda_web/rest/teleAtendimento/getTeleAtendimentoPrimeiraFila'
        $.ajax({
                type: 'POST',
                        url: Url,//mudar pro link do banco
                        dataType: 'JSON',
                        headers:{
                            'Authorization':'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxNTA2NyIsImlzcyI6IkFOREVSU09OIEZSRUlUQVMgREEgU0lMVkEiLCJpYXQiOjE1ODgxMDE3OTQsImV4cCI6MTkwMzYzNDU5NH0.qtiFO2Xb3JSnhuCT_OL4Qt829PDlRe6fKJFH-q_ln78',
                            //'Authorization':'Bearer' + localStorage.getItem("mediAgendaToken"),
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'contentLanguage': 'pt-BR'
                        },
                        data: {'idEquipamento':'41','data':'06/05/2020','hora':'10:00:00'},
                        success: function (resposta) {
                            console.log(resposta)
                            console.log(resposta.STATUS)
                            console.log(resposta.URL)
                            status = resposta.STATUS
                            link = resposta.URL
                            posicao.innerHTML = `Sua posição é: ${resposta.POSICAO}`
                            texto();
                            if (resposta.STATUS == "Conf") {
                                setTimeout(function(){window.location.href = "salaEsperaConsulta.html";},60000)
                                clearInterval(stop);           
                            
                            } else if(resposta.STATUS == "OK" && link != undefined){
                                setTimeout(function(){window.location.href = link;},60000)
                                clearInterval(stop); 
                                // resposta.limparUrl(resposta.idEquipamento,resposta.data,resposta.hora)
                                
                                    const Url2 = 'http://localhost:8080/mediagenda_web/rest/teleAtendimento/limparUrl'
                                    $.ajax({
                                        type: 'POST',
                                        url: Url2,//mudar pro link do banco
                                        dataType: 'JSON',
                                        headers:{
                                            'Authorization':'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxNTA2NyIsImlzcyI6IkFOREVSU09OIEZSRUlUQVMgREEgU0lMVkEiLCJpYXQiOjE1ODgxMDE3OTQsImV4cCI6MTkwMzYzNDU5NH0.qtiFO2Xb3JSnhuCT_OL4Qt829PDlRe6fKJFH-q_ln78',
                                            //'Authorization':'Bearer' + localStorage.getItem("mediAgendaToken"),
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                            'contentLanguage': 'pt-BR'
                                        },
                                        data: {'idEquipamento':'41','data':'06/05/2020','hora':'10:00:00'},   
                                        success: function (teste) {},
                                        error: function (teste) {
                                            console.log(teste)
                                         },
                                        complete: function () {
                                            // ao final da requisição...
                                        }
                                                         
                                    })
                                
                            }
                        
                        },
                error: function (resposta) {
                    console.log(resposta)
                },
                        complete: function () {
                        // ao final da requisição...
                        }
        });
    }, 3000);

    function texto(){
        var x = document.getElementById("texto");
  
        if(status === "OK" && link != undefined){
            x.innerHTML ="Parece que o(a) atendente teve alguma dúvida quanto aos dados, você será direcionado(a) para uma pré-tele consulta."
        } else if(status === "Conf"){
            x.innerHTML = "Sua consulta foi confirmada, Você será direcionado(a) para a fila de espera para ser consultado em alguns instantes..."
        }
    }
    });
   
</script>
</html>